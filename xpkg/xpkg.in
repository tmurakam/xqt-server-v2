#!/usr/bin/ruby

# xpkg: Package build system for X/Qt project
#
# Copyright (C) 2003-2005 Takuya Murakami
#
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
#
# You should have received a copy of the GNU General Public License
# along with this program; if not, write to the Free Software
# Foundation, Inc., 59 Temple Place - Suite 330, Boston, MA  02111-1307, USA.

$debug = false

$pkglibdir = "@pkglibdir@"
$sysconfdir = "@sysconfdir@"
$version = "@version@"

$xpkgtop = nil
$verbose = false

# 個人設定ファイル読み込み
inifile = ENV["HOME"] + "/.xpkg"
if FileTest.exist?(inifile)
    load "~/.xpkg"
end

$LOAD_PATH.push($pkglibdir)
$LOAD_PATH.push($sysconfdir)

# 共通設定ファイル読み込み
require "config"

# 再度個人設定ファイルを読み込む
# (共通設定ファイルよりこちらを優先するため)
if FileTest.exist?(inifile)
    load "~/.xpkg"
end

# ライブラリ読み込み
require "optparse"
require "pkg"
require "install"
require "pkgbuild"
require "ipkg"
require "misc"
require "workstate"


class Xpkg
    include Misc

    # メイン
    def main
	# 引数の処理
	target, mode, deffile = parse_opt()

	# ディレクトリ設定
	setupdirs(target)
	
	# deffile のロード
	pkg = Pkg.new
	pkg.loaddef(deffile, target, @destdir, $sysconfdir)

	# *World の処理
	modes = nil
	if (mode == "World")
	    modes = ["cleanup", "source", "build", "install", "pkg"]
	elsif (mode == "DevelWorld")
	    modes = ["cleanup", "source", "build", "install", "pkg", "install-develpkg"]
	else
	    modes = [mode]
	end

	# pkgbuild の準備
	pkgbuild = nil
	case pkg.df.getDefine("pkgtype")
	when "ipkg"
	    pkgbuild = IpkgBuild.new
	    pkgbuild.SetIpkgParam("#{$pkglibdir}/ipkg-build")
	else
	    pkgbuild = GenPkgBuild.new
	end
	pkgbuild.SetParam(pkg.df, @destdir, @pkgdir, @develpkgdir, ".")
	
	# workstate の準備
#	state = WorkState.new

	# ビルド処理
	st = Time.now
	modes.each do |mode|
#	    next if (mode != "clear" && state.done?(mode))

	    puts "----- Execute #{mode} with #{deffile}"
	    begin
		# mode 別の処理
		case mode
		when "source"
		    pkg.getSource(@distfiledir)
		    pkg.execSectionScript("prep")
		    pkg.execSectionScript("patch") # backword compatilibity

		when "download"
		    pkg.getSource(@distfiledir, true)

		when "pkg", "ipkg"
		    pkgbuild.Build
		    
		when "install-pkg", "install-ipkg"
		    pkgbuild.InstallLocal()

		when "install-develpkg"
		    pkgbuild.InstallDevelPackage()

		when "cleanup"
		    pkg.cleanup()

#		when "clear"
#		    state.clear
#		    state.save
		else
		    pkg.execSectionScript(mode)
		end
		
#		if (mode != "cleanup" && mode != "clear")
#		    state.setdone(mode)
#		    state.save
#		end

	    rescue
		STDERR.puts $!
		if (mode != "ipkg")
		    STDERR.puts "Abort."
		    exit 1
		end
	    end
	end

	tm = (Time.now - st).to_i

	sku = ENV["SKU"]
	if (sku != nil)
	    sk = sprintf(", %.3f SKU", tm / sku.to_f)
	else
	    sk = ""
	end
	puts "----- Compile time: #{tm} sec (#{tm / 60}:#{tm % 60}#{sk})."
	puts "done."
	exit 0
    end

    # オプションの処理
    def parse_opt
	target = ENV["TARGET"]
	if (target == nil || target == "")
	    target = $default_target  # default value
	end

	opt = OptionParser.new
        opt.banner = "xpkg version #{$version}\n" +
                 "Copyright (C) 2003-2005 X/Qt Project\n" + 
                 "This program may be freely redistributed under the terms of the GNU GPL\n\n" + 
                 "Usage: xpkg [option...] [mode] [deffile]"
	opt.on_head(" mode: source|build|clean|cleanup|pkg|install-develpkg|install-ipkg\n option:")

	opt.on("-h", "--help", "Show this message") { puts opt; exit 1; }
	opt.on("-t", "--target=TARGET", String, "Specify target") {|v| target = v }
	opt.on("-v", "--verbose", "Verbose") {$verbose = true}

	opt.parse!(ARGV)
	
	if (ARGV.size < 1)
	    puts opt
	    exit 1
	end

	mode = ARGV.shift
	deffile = ARGV.shift
	
	if (deffile == nil)
	    if (File.exist?("pkgdef"))
		deffile = "pkgdef"
	    else
		STDERR.puts "pkgdef does not exist."
		exit 1
	    end
	end

	return target, mode, deffile
    end
end

xpkg = Xpkg.new
xpkg.main
